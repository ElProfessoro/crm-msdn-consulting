<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lead - CRM Connect</title>
  <link rel="stylesheet" href="/src/styles/global.css">
  <style>
    .lead-layout {
      display: grid;
      grid-template-columns: 400px 1fr;
      gap: 24px;
    }

    .lead-profile {
      background: white;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      padding: 32px;
    }

    .profile-header {
      text-align: center;
      margin-bottom: 32px;
    }

    .profile-avatar-large {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      margin: 0 auto 16px;
      object-fit: cover;
      position: relative;
      background-color: var(--gray-200);
    }

    .online-indicator {
      position: absolute;
      bottom: 4px;
      right: 4px;
      width: 16px;
      height: 16px;
      background-color: #22c55e;
      border: 3px solid white;
      border-radius: 50%;
    }

    .profile-name {
      font-size: 22px;
      font-weight: 600;
      color: var(--gray-900);
      margin-bottom: 4px;
    }

    .profile-position {
      font-size: 14px;
      color: var(--gray-600);
      margin-bottom: 8px;
    }

    .profile-company {
      font-size: 14px;
      color: var(--primary-blue);
      margin-bottom: 16px;
    }

    .profile-actions {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 32px;
    }

    .section-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--gray-600);
      text-transform: uppercase;
      margin-bottom: 12px;
      letter-spacing: 0.5px;
    }

    .info-item {
      margin-bottom: 16px;
    }

    .info-label {
      font-size: 12px;
      color: var(--gray-500);
      margin-bottom: 4px;
    }

    .info-value {
      font-size: 14px;
      color: var(--gray-900);
      word-break: break-all;
    }

    .tags-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .tag {
      padding: 4px 12px;
      background-color: var(--gray-100);
      border-radius: 12px;
      font-size: 12px;
      color: var(--gray-700);
    }

    .tabs {
      display: flex;
      gap: 24px;
      border-bottom: 2px solid var(--border-color);
      margin-bottom: 24px;
    }

    .tab {
      padding: 12px 0;
      font-size: 14px;
      font-weight: 500;
      color: var(--gray-600);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      transition: all 0.15s;
    }

    .tab.active {
      color: var(--primary-blue);
      border-bottom-color: var(--primary-blue);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .activity-input {
      background-color: var(--gray-50);
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      padding: 12px;
      margin-bottom: 16px;
    }

    .activity-input textarea {
      width: 100%;
      border: none;
      background: transparent;
      resize: none;
      font-family: var(--font-sans);
      font-size: 14px;
      outline: none;
      min-height: 60px;
    }

    .activity-input-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 8px;
    }

    .timeline {
      position: relative;
    }

    .timeline-item {
      display: flex;
      gap: 16px;
      margin-bottom: 24px;
    }

    .timeline-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      font-size: 18px;
    }

    .timeline-content {
      flex: 1;
      background: var(--gray-50);
      border-radius: var(--radius-lg);
      padding: 16px;
    }

    .timeline-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 8px;
    }

    .timeline-title {
      font-weight: 600;
      color: var(--gray-900);
      font-size: 14px;
    }

    .timeline-author {
      font-size: 13px;
      color: var(--gray-600);
    }

    .timeline-time {
      font-size: 12px;
      color: var(--gray-500);
    }

    .timeline-description {
      font-size: 14px;
      color: var(--gray-700);
      line-height: 1.6;
      margin-top: 8px;
    }

    .breadcrumb {
      margin-bottom: 24px;
      font-size: 14px;
      color: var(--gray-600);
    }

    .breadcrumb a {
      color: var(--primary-blue);
    }

    /* Actions rapides */
    .quick-actions-section {
      margin-bottom: 24px;
      padding-bottom: 24px;
      border-bottom: 1px solid var(--border-color);
    }

    .quick-actions-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .btn-quick-action {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      padding: 12px 8px;
      background: var(--gray-50);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s ease;
      font-size: 11px;
      font-weight: 500;
      color: var(--gray-700);
    }

    .btn-quick-action:hover {
      background: var(--gray-100);
      border-color: var(--primary-blue);
      transform: translateY(-1px);
    }

    .btn-quick-action:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .btn-quick-action-danger {
      background: #fef2f2;
      border-color: #fecaca;
      color: #dc2626;
    }

    .btn-quick-action-danger:hover {
      background: #fee2e2;
      border-color: #ef4444;
    }

    .quick-action-icon {
      font-size: 20px;
    }

    .quick-action-label {
      text-align: center;
      line-height: 1.2;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <main class="main-content">
      <div class="breadcrumb">
        <a href="/leads.html">Leads</a> &gt; <span id="breadcrumbName">...</span>
      </div>

      <div class="lead-layout">
        <!-- Colonne gauche - Profil -->
        <div class="lead-profile">
          <div class="profile-header">
            <div style="position: relative; display: inline-block;">
              <img id="profileAvatar" src="" alt="" class="profile-avatar-large" onerror="this.style.display='none'; document.getElementById('profileAvatarFallback').style.display='flex';">
              <div id="profileAvatarFallback" class="profile-avatar-large" style="display: none; align-items: center; justify-content: center; font-weight: 700; font-size: 48px; color: white;"></div>
            </div>
            <h2 class="profile-name" id="profileName">-</h2>
            <div class="profile-position" id="profilePosition">-</div>
            <div class="profile-company" id="profileCompany">-</div>
            <div>
              <span class="badge" id="profileStatus">-</span>
            </div>
          </div>

          <div class="quick-actions-section">
            <div class="section-label">ACTIONS RAPIDES</div>
            <div class="quick-actions-grid">
              <button class="btn-quick-action" onclick="quickAction('call_made')" id="btnCallMade">
                <span class="quick-action-icon">üìû</span>
                <span class="quick-action-label">Appel effectu√©</span>
              </button>
              <button class="btn-quick-action" onclick="quickAction('to_callback')" id="btnToCallback">
                <span class="quick-action-icon">‚è∞</span>
                <span class="quick-action-label">√Ä rappeler</span>
              </button>
              <button class="btn-quick-action" onclick="quickAction('message_left')" id="btnMessageLeft">
                <span class="quick-action-icon">üí¨</span>
                <span class="quick-action-label">Message laiss√©</span>
              </button>
              <button class="btn-quick-action" onclick="quickAction('no_answer')" id="btnNoAnswer">
                <span class="quick-action-icon">üìµ</span>
                <span class="quick-action-label">Ne r√©pond pas</span>
              </button>
              <button class="btn-quick-action btn-quick-action-danger" onclick="quickAction('do_not_contact')" id="btnDoNotContact">
                <span class="quick-action-icon">üö´</span>
                <span class="quick-action-label">Ne plus contacter</span>
              </button>
            </div>
          </div>

          <div class="profile-actions">
            <button class="btn btn-primary" onclick="sendEmail()">
              üìß Envoyer un e-mail
            </button>
            <button class="btn btn-secondary" onclick="makeCall()">
              üìû Appeler
            </button>
          </div>

          <div class="section-label">Coordonn√©es</div>
          <div class="info-item">
            <div class="info-label">EMAIL</div>
            <div class="info-value" id="contactEmail">-</div>
          </div>
          <div class="info-item">
            <div class="info-label">T√âL√âPHONE</div>
            <div class="info-value" id="contactPhone">-</div>
          </div>
          <div class="info-item">
            <div class="info-label">ENTREPRISE</div>
            <div class="info-value" id="contactCompany">-</div>
          </div>
          <div class="info-item">
            <div class="info-label">LINKEDIN</div>
            <div class="info-value" id="contactLinkedin">-</div>
          </div>

          <div class="section-label" style="margin-top: 24px;">STATUT</div>
          <div class="info-item">
            <select id="leadStatus" onchange="changeLeadStatus()" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; background: white;">
              <option value="nouveau">üÜï Nouveau</option>
              <option value="en_cours">üîÑ En cours</option>
              <option value="gagne">üèÜ Gagn√©</option>
              <option value="perdu">‚ùå Perdu</option>
              <option value="ne_plus_contacter">üö´ Ne plus contacter</option>
            </select>
          </div>

          <div class="section-label" style="margin-top: 24px;">TAGS</div>
          <div class="tags-container" id="tagsContainer">-</div>

          <!-- Section de r√©assignation (visible uniquement pour les admins) -->
          <div id="reassignSection" style="display: none; margin-top: 32px;">
            <div class="section-label">ASSIGNATION</div>
            <div class="info-item">
              <div class="info-label">ASSIGN√â √Ä</div>
              <select id="assignedUser" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px; margin-top: 4px;">
                <option value="">Chargement...</option>
              </select>
            </div>
            <button class="btn btn-primary" onclick="reassignLead()" style="width: 100%; margin-top: 8px;">
              üîÑ R√©assigner
            </button>
          </div>
        </div>

        <!-- Colonne droite - Historique -->
        <div>
          <div class="card">
            <div class="tabs">
              <div class="tab active" data-tab="historique">Historique</div>
              <div class="tab" data-tab="notes">Notes</div>
              <div class="tab" data-tab="taches">T√¢ches</div>
            </div>

            <div class="tab-content active" id="historique">
              <div class="activity-input">
                <textarea
                  placeholder="Ajouter une note ou consigner un appel..."
                  id="noteInput"
                ></textarea>
                <div class="activity-input-actions">
                  <button class="btn btn-secondary" style="font-size: 13px; padding: 6px 12px;">üìé</button>
                  <button class="btn btn-secondary" style="font-size: 13px; padding: 6px 12px;">@</button>
                  <button class="btn btn-secondary" style="font-size: 13px; padding: 6px 12px;">B</button>
                  <button class="btn btn-primary" style="font-size: 13px; padding: 6px 16px;" onclick="saveNote()">
                    Enregistrer
                  </button>
                </div>
              </div>

              <div class="timeline" id="timeline">
                <div style="text-align: center; padding: 24px; color: var(--gray-500);">
                  Chargement...
                </div>
              </div>
            </div>

            <div class="tab-content" id="notes">
              Notes √† venir...
            </div>

            <div class="tab-content" id="taches">
              <div style="margin-bottom: 16px;">
                <button class="btn btn-primary btn-sm" onclick="addTaskForLead()">
                  ‚ûï Nouvelle t√¢che
                </button>
              </div>

              <div id="leadTasks">
                <div style="text-align: center; padding: 24px; color: var(--gray-500);">
                  Chargement...
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Modal de cr√©ation de t√¢che pour ce lead -->
  <div class="modal" id="leadTaskModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div class="modal-content" style="background: white; border-radius: 12px; padding: 32px; width: 90%; max-width: 500px;">
      <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <h3 style="font-size: 18px; font-weight: 600; margin: 0;">Nouvelle t√¢che</h3>
        <button onclick="closeLeadTaskModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--gray-400);">√ó</button>
      </div>

      <form id="leadTaskForm" onsubmit="saveLeadTask(event)">
        <div class="form-group">
          <label class="form-label">Titre *</label>
          <input type="text" id="leadTaskTitle" class="form-input" required placeholder="Ex: Relancer par email">
        </div>

        <div class="form-group">
          <label class="form-label">Description</label>
          <textarea id="leadTaskDescription" class="form-textarea" rows="3"></textarea>
        </div>

        <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
          <div class="form-group">
            <label class="form-label">Priorit√©</label>
            <select id="leadTaskPriority" class="form-input">
              <option value="basse">Basse</option>
              <option value="normale" selected>Normale</option>
              <option value="haute">Haute</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Date d'√©ch√©ance</label>
            <input type="date" id="leadTaskDueAt" class="form-input">
          </div>
        </div>

        <div class="form-actions" style="margin-top: 24px; display: flex; gap: 12px; justify-content: flex-end;">
          <button type="button" class="btn btn-secondary" onclick="closeLeadTaskModal()">Annuler</button>
          <button type="submit" class="btn btn-primary">Cr√©er</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal de rappel -->
  <div class="modal" id="callbackModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div class="modal-content" style="background: white; border-radius: 12px; padding: 32px; width: 90%; max-width: 450px;">
      <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <h3 style="font-size: 18px; font-weight: 600; margin: 0;">‚è∞ Planifier un rappel</h3>
        <button onclick="closeCallbackModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--gray-400);">√ó</button>
      </div>
      <form id="callbackForm" onsubmit="submitCallback(event)">
        <div class="form-group">
          <label class="form-label">Date et heure du rappel *</label>
          <input type="datetime-local" id="callbackDatetime" class="form-input" required>
        </div>
        <div class="form-group">
          <label class="form-label">Note (optionnel)</label>
          <textarea id="callbackNote" class="form-textarea" rows="3" placeholder="Contexte du rappel..."></textarea>
        </div>
        <div class="form-actions" style="margin-top: 24px; display: flex; gap: 12px; justify-content: flex-end;">
          <button type="button" class="btn btn-secondary" onclick="closeCallbackModal()">Annuler</button>
          <button type="submit" class="btn btn-primary">Cr√©er le rappel</button>
        </div>
      </form>
    </div>
  </div>

  <script src="/src/lib/api.js"></script>
  <script src="/src/lib/utils.js"></script>
  <script src="/src/components/sidebar.js"></script>
  <script>
    if (!utils.requireAuth()) throw new Error('Not authenticated');

    const sidebar = new Sidebar('leads');
    sidebar.init();

    const leadId = new URLSearchParams(window.location.search).get('id');
    let currentLead = null;
    let currentUser = null;
    let allUsers = [];

    if (!leadId) {
      window.location.href = '/leads.html';
    }

    // Tabs
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab).classList.add('active');
      });
    });

    async function loadLead() {
      try {
        const [leadResponse, activitiesResponse, userResponse] = await Promise.all([
          api.getLead(leadId),
          api.getLeadActivities(leadId),
          api.getMe()
        ]);

        currentLead = leadResponse.lead;
        currentUser = userResponse.user;
        renderLead(currentLead);
        renderActivities(activitiesResponse.activities);

        // Charger les utilisateurs si admin
        if (currentUser.role === 'admin') {
          await loadUsers();
        }
      } catch (error) {
        console.error('Error loading lead:', error);
        utils.showError('Erreur lors du chargement du lead');
      }
    }

    async function loadUsers() {
      try {
        const data = await api.getUsers();
        allUsers = data.users || [];

        // Afficher la section de r√©assignation
        document.getElementById('reassignSection').style.display = 'block';

        // Remplir le dropdown
        const select = document.getElementById('assignedUser');
        select.innerHTML = allUsers.map(user =>
          `<option value="${user.id}" ${user.id === currentLead.user_id ? 'selected' : ''}>
            ${user.first_name} ${user.last_name} ${user.role === 'admin' ? '(Admin)' : ''}
          </option>`
        ).join('');
      } catch (error) {
        console.error('Error loading users:', error);
        // Ne pas afficher d'erreur, juste masquer la section
      }
    }

    function renderLead(lead) {
      // G√©n√©rer les initiales et couleur pour l'avatar
      const initials = utils.getInitials(lead.first_name, lead.last_name);
      const colors = ['#2563eb', '#7c3aed', '#db2777', '#dc2626', '#ea580c', '#16a34a', '#0891b2', '#4f46e5'];
      const bgColor = colors[lead.id % colors.length];

      document.getElementById('breadcrumbName').textContent = lead.full_name || lead.email;

      // Afficher l'avatar avec initiales
      document.getElementById('profileAvatar').style.display = 'none';
      const fallback = document.getElementById('profileAvatarFallback');
      fallback.style.display = 'flex';
      fallback.style.backgroundColor = bgColor;
      fallback.textContent = initials;

      document.getElementById('profileName').textContent = lead.full_name || '-';
      document.getElementById('profilePosition').textContent = lead.position || '-';

      // Extraire le lien LinkedIn de l'entreprise depuis les notes
      let companyLinkedinUrl = null;
      if (lead.notes) {
        const match = lead.notes.match(/LinkedIn Entreprise:\s*(https:\/\/[^\s\n]+)/);
        if (match) {
          companyLinkedinUrl = match[1];
        }
      }

      document.getElementById('profileCompany').innerHTML = lead.company
        ? (companyLinkedinUrl
            ? `<a href="${companyLinkedinUrl}" target="_blank" rel="noopener noreferrer">${lead.company}</a>`
            : lead.company)
        : '-';

      const statusBadge = document.getElementById('profileStatus');
      statusBadge.textContent = utils.getStatusLabel(lead.status);
      statusBadge.className = `badge ${utils.getStatusBadgeClass(lead.status)}`;

      // Mettre √† jour le dropdown de statut
      document.getElementById('leadStatus').value = lead.status;

      document.getElementById('contactEmail').textContent = lead.email || '-';
      document.getElementById('contactPhone').textContent = lead.phone || '-';
      document.getElementById('contactCompany').textContent = lead.company || '-';
      document.getElementById('contactLinkedin').innerHTML = lead.linkedin_url
        ? `<a href="${lead.linkedin_url}" target="_blank">${lead.linkedin_url}</a>`
        : '-';

      const tags = utils.parseTags(lead.tags);
      document.getElementById('tagsContainer').innerHTML = tags.length > 0
        ? tags.map(tag => `<span class="tag">${tag}</span>`).join('')
        : '<span style="color: var(--gray-500); font-size: 13px;">Aucun tag</span>';

      // Afficher bandeau RGPD si n√©cessaire
      if (lead.status === 'ne_plus_contacter') {
        // Supprimer bandeau existant s'il y en a un
        const existingBanner = document.querySelector('.rgpd-warning-banner');
        if (existingBanner) existingBanner.remove();

        const warningBanner = document.createElement('div');
        warningBanner.className = 'rgpd-warning-banner';
        warningBanner.style.cssText = 'background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 12px; margin: 16px 0; display: flex; align-items: center; gap: 8px;';
        warningBanner.innerHTML = `
          <span style="font-size: 20px;">üö´</span>
          <div style="flex: 1;">
            <div style="font-weight: 600; color: #dc2626; font-size: 13px;">Ne plus contacter</div>
            <div style="font-size: 12px; color: #991b1b;">Ce lead ne souhaite plus √™tre contact√© (RGPD)</div>
          </div>
        `;
        document.querySelector('.profile-header').insertAdjacentElement('afterend', warningBanner);

        // D√©sactiver boutons sauf do_not_contact
        ['btnCallMade', 'btnToCallback', 'btnMessageLeft', 'btnNoAnswer'].forEach(id => {
          const btn = document.getElementById(id);
          if (btn) btn.setAttribute('disabled', 'true');
        });

        // Masquer bouton nouvelle t√¢che
        const addTaskBtn = document.querySelector('button[onclick="addTaskForLead()"]');
        if (addTaskBtn) addTaskBtn.style.display = 'none';
      } else {
        // R√©activer les boutons si le statut change
        const existingBanner = document.querySelector('.rgpd-warning-banner');
        if (existingBanner) existingBanner.remove();

        ['btnCallMade', 'btnToCallback', 'btnMessageLeft', 'btnNoAnswer'].forEach(id => {
          const btn = document.getElementById(id);
          if (btn) btn.removeAttribute('disabled');
        });

        const addTaskBtn = document.querySelector('button[onclick="addTaskForLead()"]');
        if (addTaskBtn) addTaskBtn.style.display = '';
      }
    }

    function renderActivities(activities) {
      const timeline = document.getElementById('timeline');

      if (!activities || activities.length === 0) {
        timeline.innerHTML = `
          <div style="text-align: center; padding: 24px; color: var(--gray-500);">
            Aucune activit√©
          </div>
        `;
        return;
      }

      const icons = {
        call_made: { icon: 'üìû', bg: '#dbeafe', color: '#2563eb' },
        email_sent: { icon: 'üìß', bg: '#dbeafe', color: '#2563eb' },
        note_added: { icon: 'üìù', bg: '#f3e8ff', color: '#9333ea' },
        status_changed: { icon: 'üîÑ', bg: '#dcfce7', color: '#22c55e' },
        lead_created: { icon: '‚ú®', bg: '#fef3c7', color: '#d97706' },
        task_created: { icon: '‚úì', bg: '#dbeafe', color: '#2563eb' },
        task_updated: { icon: 'üîÑ', bg: '#dcfce7', color: '#22c55e' },
        lead_reassigned: { icon: 'üë•', bg: '#fef3c7', color: '#f59e0b' },
        to_callback: { icon: '‚è∞', bg: '#fef3c7', color: '#f59e0b' },
        message_left: { icon: 'üí¨', bg: '#e0e7ff', color: '#6366f1' },
        no_answer: { icon: 'üìµ', bg: '#fee2e2', color: '#ef4444' },
        do_not_contact: { icon: 'üö´', bg: '#fef2f2', color: '#dc2626' },
      };

      timeline.innerHTML = activities.map(activity => {
        const style = icons[activity.activity_type] || icons.note_added;

        // Ajouter un badge de statut pour les appels
        let statusBadge = '';
        if (activity.call_status) {
          const statusLabels = {
            'ringing': { text: 'En cours...', color: '#f59e0b' },
            'answered': { text: 'D√©croch√©', color: '#10b981' },
            'ended': { text: 'Termin√©', color: '#6b7280' },
            'missed': { text: 'Manqu√©', color: '#ef4444' }
          };
          const status = statusLabels[activity.call_status] || { text: activity.call_status, color: '#6b7280' };
          statusBadge = `<span style="display: inline-block; padding: 2px 8px; background: ${status.color}20; color: ${status.color}; border-radius: 12px; font-size: 11px; font-weight: 600; margin-left: 8px;">${status.text}</span>`;
        }

        // Afficher la dur√©e de l'appel si disponible
        let callDuration = '';
        if (activity.call_duration) {
          const minutes = Math.floor(activity.call_duration / 60);
          const seconds = activity.call_duration % 60;
          callDuration = `<div style="font-size: 12px; color: #6b7280; margin-top: 4px;">‚è±Ô∏è Dur√©e: ${minutes}m ${seconds}s</div>`;
        }

        // Afficher le lien d'enregistrement si disponible
        let recordingLink = '';
        if (activity.recording_url) {
          recordingLink = `
            <div style="margin-top: 8px;">
              <audio controls style="width: 100%; max-width: 400px; height: 32px;">
                <source src="${activity.recording_url}" type="audio/mpeg">
                Votre navigateur ne supporte pas la lecture audio.
              </audio>
              <a href="${activity.recording_url}" target="_blank" style="display: inline-block; margin-top: 4px; font-size: 12px; color: var(--primary-blue);">
                üì• T√©l√©charger l'enregistrement
              </a>
            </div>
          `;
        }

        return `
          <div class="timeline-item">
            <div class="timeline-icon" style="background-color: ${style.bg}; color: ${style.color};">
              ${style.icon}
            </div>
            <div class="timeline-content">
              <div class="timeline-header">
                <div>
                  <div class="timeline-title">${activity.title}${statusBadge}</div>
                  <div class="timeline-author">${activity.first_name} ${activity.last_name}</div>
                </div>
                <div class="timeline-time">${utils.formatDateTime(activity.created_at)}</div>
              </div>
              ${activity.description ? `<div class="timeline-description">${activity.description}</div>` : ''}
              ${callDuration}
              ${recordingLink}
            </div>
          </div>
        `;
      }).join('');
    }

    async function saveNote() {
      const noteInput = document.getElementById('noteInput');
      const note = noteInput.value.trim();

      if (!note) {
        utils.showError('Veuillez saisir une note');
        return;
      }

      try {
        await api.addLeadActivity(leadId, {
          activity_type: 'note_added',
          title: 'Note ajout√©e',
          description: note
        });

        noteInput.value = '';
        utils.showSuccess('Note ajout√©e');
        loadLead();
      } catch (error) {
        console.error('Error saving note:', error);
        utils.showError('Erreur lors de l\'ajout de la note');
      }
    }

    function sendEmail() {
      if (currentLead?.email) {
        window.location.href = `mailto:${currentLead.email}`;
      } else {
        utils.showError('Aucun email disponible');
      }
    }

    async function makeCall() {
      if (!currentLead?.phone) {
        utils.showError('Aucun num√©ro de t√©l√©phone disponible pour ce lead');
        return;
      }

      // Demander confirmation
      if (!confirm(`Appeler ${currentLead.full_name || currentLead.company} au ${currentLead.phone} ?\n\nVotre t√©l√©phone va sonner, puis l'appel sera connect√©.`)) {
        return;
      }

      try {
        // Initier l'appel via RingOver
        const response = await api.initiateCall(currentLead.phone, leadId);

        if (response.success) {
          utils.showSuccess('Appel en cours d\'initiation... Votre t√©l√©phone va sonner.');
          // Recharger pour afficher la nouvelle activit√©
          setTimeout(() => loadLead(), 2000);
        }
      } catch (error) {
        console.error('Error initiating call:', error);
        utils.showError(error.message || 'Erreur lors de l\'initiation de l\'appel');
      }
    }

    async function changeLeadStatus() {
      const newStatus = document.getElementById('leadStatus').value;
      const oldStatus = currentLead.status;

      if (newStatus === oldStatus) {
        return; // Pas de changement
      }

      try {
        const response = await fetch(`${api.API_URL}/leads/${leadId}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ status: newStatus })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Erreur lors du changement de statut');
        }

        const data = await response.json();
        currentLead = data.lead;

        // Mettre √† jour le badge de statut
        const statusBadge = document.getElementById('profileStatus');
        statusBadge.textContent = utils.getStatusLabel(newStatus);
        statusBadge.className = `badge ${utils.getStatusBadgeClass(newStatus)}`;

        utils.showSuccess(`Statut chang√©: ${utils.getStatusLabel(oldStatus)} ‚Üí ${utils.getStatusLabel(newStatus)}`);

        // Recharger les activit√©s pour voir la notification de changement de statut
        const activitiesResponse = await api.getLeadActivities(leadId);
        renderActivities(activitiesResponse.activities);
      } catch (error) {
        console.error('Error changing status:', error);
        utils.showError(error.message || 'Erreur lors du changement de statut');
        // Remettre l'ancien statut en cas d'erreur
        document.getElementById('leadStatus').value = oldStatus;
      }
    }

    async function reassignLead() {
      const select = document.getElementById('assignedUser');
      const newUserId = parseInt(select.value);

      if (newUserId === currentLead.user_id) {
        utils.showError('Le lead est d√©j√† assign√© √† cet utilisateur');
        return;
      }

      if (!confirm('√ätes-vous s√ªr de vouloir r√©assigner ce lead ?')) {
        return;
      }

      try {
        const response = await fetch(`${api.API_URL}/leads/${leadId}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ user_id: newUserId })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Erreur lors de la r√©assignation');
        }

        const data = await response.json();
        currentLead = data.lead;

        utils.showSuccess('Lead r√©assign√© avec succ√®s');

        // Recharger les activit√©s pour voir la notification de r√©assignation
        const activitiesResponse = await api.getLeadActivities(leadId);
        renderActivities(activitiesResponse.activities);
      } catch (error) {
        console.error('Error reassigning lead:', error);
        utils.showError(error.message || 'Erreur lors de la r√©assignation');
      }
    }

    async function loadLeadTasks() {
      try {
        const response = await api.getTasks({ lead_id: leadId });
        const tasks = response.tasks || [];

        const container = document.getElementById('leadTasks');

        if (tasks.length === 0) {
          container.innerHTML = `
            <div style="text-align: center; padding: 32px; color: var(--gray-500);">
              <div style="font-size: 32px; margin-bottom: 8px;">üìã</div>
              <div>Aucune t√¢che pour ce lead</div>
            </div>
          `;
          return;
        }

        container.innerHTML = tasks.map(task => {
          const isOverdue = task.due_at && new Date(task.due_at) < new Date() && task.status !== 'termine';
          const isCompleted = task.status === 'termine';

          return `
            <div style="padding: 16px; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 12px; ${isOverdue ? 'background: #fef2f2; border-left: 4px solid #dc2626;' : ''}">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                <div style="flex: 1;">
                  <div style="font-weight: 600; color: var(--gray-900); ${isCompleted ? 'text-decoration: line-through; color: var(--gray-500);' : ''}">${task.title}</div>
                  ${task.description ? `<div style="font-size: 13px; color: var(--gray-600); margin-top: 4px;">${task.description}</div>` : ''}
                </div>
                <input type="checkbox" ${isCompleted ? 'checked' : ''} onchange="toggleLeadTaskStatus(${task.id}, '${task.status}')" style="cursor: pointer;">
              </div>
              <div style="display: flex; gap: 12px; font-size: 12px; color: var(--gray-500);">
                <span class="badge ${utils.getStatusBadgeClass(task.status)}">${utils.getTaskStatusLabel(task.status)}</span>
                <span class="badge badge-${task.priority === 'haute' ? 'red' : task.priority === 'normale' ? 'yellow' : 'green'}">${utils.getPriorityLabel(task.priority)}</span>
                ${task.due_at ? `<span>‚è∞ ${utils.formatDate(task.due_at)}${isOverdue ? ' <span style="color: #dc2626;">‚ö†Ô∏è En retard</span>' : ''}</span>` : ''}
              </div>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Error loading lead tasks:', error);
      }
    }

    function addTaskForLead() {
      document.getElementById('leadTaskModal').style.display = 'flex';
      document.getElementById('leadTaskForm').reset();
    }

    function closeLeadTaskModal() {
      document.getElementById('leadTaskModal').style.display = 'none';
    }

    async function saveLeadTask(event) {
      event.preventDefault();

      const taskData = {
        title: document.getElementById('leadTaskTitle').value,
        description: document.getElementById('leadTaskDescription').value || null,
        priority: document.getElementById('leadTaskPriority').value,
        due_at: document.getElementById('leadTaskDueAt').value || null,
        lead_id: parseInt(leadId),
        status: 'a_faire'
      };

      try {
        await api.createTask(taskData);
        utils.showSuccess('T√¢che cr√©√©e');
        closeLeadTaskModal();
        loadLeadTasks();

        // Recharger les activit√©s pour voir la nouvelle t√¢che
        const activitiesResponse = await api.getLeadActivities(leadId);
        renderActivities(activitiesResponse.activities);
      } catch (error) {
        console.error('Error creating task:', error);
        utils.showError('Erreur lors de la cr√©ation de la t√¢che');
      }
    }

    // Actions rapides
    async function quickAction(actionType) {
      if (actionType === 'to_callback') {
        // Ouvrir modal pour date
        document.getElementById('callbackModal').style.display = 'flex';
        // D√©finir date min = maintenant
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('callbackDatetime').min = now.toISOString().slice(0, 16);
        return;
      }

      if (actionType === 'do_not_contact') {
        if (!confirm('‚ö†Ô∏è √ätes-vous s√ªr de vouloir marquer ce lead comme "Ne plus contacter" ?\n\nCette action bloquera toute future interaction (RGPD).')) {
          return;
        }
      }

      try {
        await api.quickAction(leadId, { action_type: actionType });
        utils.showSuccess(getActionConfirmationMessage(actionType));
        loadLead(); // Recharger
      } catch (error) {
        console.error('Error with quick action:', error);
        utils.showError(error.message || 'Erreur lors de l\'action');
      }
    }

    async function submitCallback(event) {
      event.preventDefault();

      const callbackDatetime = document.getElementById('callbackDatetime').value;
      const callbackNote = document.getElementById('callbackNote').value;

      // Valider date future
      if (new Date(callbackDatetime) <= new Date()) {
        utils.showError('La date de rappel doit √™tre dans le futur');
        return;
      }

      try {
        await api.quickAction(leadId, {
          action_type: 'to_callback',
          callback_datetime: callbackDatetime,
          note: callbackNote || undefined
        });

        closeCallbackModal();
        utils.showSuccess('Rappel programm√© et t√¢che cr√©√©e');
        loadLead();
      } catch (error) {
        console.error('Error creating callback:', error);
        utils.showError(error.message || 'Erreur lors de la cr√©ation du rappel');
      }
    }

    function closeCallbackModal() {
      document.getElementById('callbackModal').style.display = 'none';
      document.getElementById('callbackForm').reset();
    }

    function getActionConfirmationMessage(actionType) {
      const messages = {
        'call_made': 'Appel enregistr√© avec succ√®s',
        'message_left': 'Message enregistr√© avec succ√®s',
        'no_answer': 'Absence de r√©ponse enregistr√©e',
        'do_not_contact': 'Lead marqu√© comme "Ne plus contacter" (RGPD)'
      };
      return messages[actionType] || 'Action enregistr√©e';
    }

    async function toggleLeadTaskStatus(taskId, currentStatus) {
      const newStatus = currentStatus === 'termine' ? 'a_faire' : 'termine';

      try {
        await api.updateTask(taskId, { status: newStatus });
        utils.showSuccess(newStatus === 'termine' ? 'T√¢che termin√©e ‚úì' : 'T√¢che r√©ouverte');
        loadLeadTasks();

        // Recharger les activit√©s
        const activitiesResponse = await api.getLeadActivities(leadId);
        renderActivities(activitiesResponse.activities);
      } catch (error) {
        console.error('Error updating task:', error);
        utils.showError('Erreur lors de la mise √† jour');
      }
    }

    // Charger les t√¢ches quand l'onglet T√¢ches est ouvert
    document.querySelectorAll('.tab').forEach(tab => {
      const originalClickHandler = tab.onclick;
      tab.onclick = function() {
        if (originalClickHandler) originalClickHandler.call(this);
        if (this.dataset.tab === 'taches') {
          loadLeadTasks();
        }
      };
    });

    loadLead();

    // Initialiser le SDK RingOver
    let ringoverIntegration;
    if (window.RingoverIntegration) {
      ringoverIntegration = new window.RingoverIntegration(api);
      ringoverIntegration.init();
    }
  </script>

  <!-- SDK RingOver -->
  <script src="https://webcdn.ringover.com/resources/SDK/1.1.3/ringover-sdk.js" type="text/javascript"></script>
  <script src="/src/lib/ringover-integration.js"></script>
</body>
</html>
